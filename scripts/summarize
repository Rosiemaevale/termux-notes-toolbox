#!/usr/bin/env bash
FILE="$HOME/notes/notes.txt"
DATE=$(date +"%Y-%m-%d")

if [ ! -f "$FILE" ]; then
  echo "no notes yet."
  exit 1
fi

# Extract today's block (supports day separators or timestamp lines)
BLOCK=$(
  awk -v d="$DATE" '
    $0 ~ "^===== "d" =====" {inblock=1; next}
    $0 ~ "^===== [0-9]{4}-[0-9]{2}-[0-9]{2} =====" && inblock==1 {exit}
    inblock==1 {print}
  ' "$FILE"
)

if [ -z "$BLOCK" ]; then
  BLOCK=$(rg "^\[$DATE" "$FILE" 2>/dev/null || true)
fi

if [ -z "$BLOCK" ]; then
  echo "no entries for today."
  exit 0
fi

echo "===== SUMMARY: $DATE ====="
echo

# Entry count
COUNT=$(echo "$BLOCK" | rg -c "^\[$DATE( [0-9]{2}:[0-9]{2})?\]" 2>/dev/null || echo 0)
echo "entries: $COUNT"
echo

# Top tags
echo "top tags:"
TAGS=$(echo "$BLOCK" | rg -o "#[A-Za-z0-9_/-]+" | sort | uniq -c | sort -nr | head -n 5)
if [ -n "$TAGS" ]; then
  echo "$TAGS"
else
  echo "(none)"
fi
echo

# Repeated words (basic noise filter)
echo "repeated words:"
echo "$BLOCK" \
  | tr '[:upper:]' '[:lower:]' \
  | rg -o "[a-z]{4,}" \
  | rg -v "this|that|with|from|have|there|about|would|could|should|because|after|before|where|which|their|them|when|then|just|like|really|still|maybe|today|right|think|thing|things|going|around|without|feel|feels|felt|make|made" \
  | sort | uniq -c | sort -nr | head -n 8
echo

# Time clustering
echo "activity by hour:"
echo "$BLOCK" \
  | rg -o "\[$DATE ([0-9]{2}):[0-9]{2}\]" \
  | sed -E 's/.* ([0-9]{2}).*/\1/' \
  | sort | uniq -c | sort -n
echo

# One-line takeaway (heuristic)
TOP_TAG=$(echo "$TAGS" | awk 'NR==1 {print $2}')
TOP_WORD=$(echo "$BLOCK" \
  | tr '[:upper:]' '[:lower:]' \
  | rg -o "[a-z]{4,}" \
  | sort | uniq -c | sort -nr | awk 'NR==1 {print $2}')

echo "takeaway:"
if [ -n "$TOP_TAG" ] && [ -n "$TOP_WORD" ]; then
  echo "most focus on $TOP_TAG, recurring theme: \"$TOP_WORD\""
elif [ -n "$TOP_TAG" ]; then
  echo "most focus on $TOP_TAG"
elif [ -n "$TOP_WORD" ]; then
  echo "recurring theme: \"$TOP_WORD\""
else
  echo "low signal day"
fi
